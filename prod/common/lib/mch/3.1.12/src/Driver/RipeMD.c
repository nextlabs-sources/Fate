// ***************************************************************
//  RipeMD.c                  version: 1.0.0  ·  date: 2010-01-10
//  -------------------------------------------------------------
//  RipeMD hash functions
//  -------------------------------------------------------------
//  Copyright (C) 1999 - 2010 www.madshi.net, All Rights Reserved
// ***************************************************************

// 2010-01-10 1.0.0 initial release

#include "RipeMD.h"

// ********************************************************************

void InitHash(THashContext *Context)
// initialize hash calculation
{
  memset(Context, 0, sizeof(THashContext));
  Context->State[0] = 0x67452301;
  Context->State[1] = 0xefcdab89;
  Context->State[2] = 0x98badcfe;
  Context->State[3] = 0x10325476;
  Context->State[4] = 0xc3d2e1f0;
}

// ********************************************************************

void CalculateHash(unsigned int *Data, unsigned int *X)
// internal function
{
  #define k1 0x5a827999 
  #define k2 0x6ed9eba1 
  #define k3 0x8f1bbcdc 
  #define k4 0xa953fd4e 
  #define k5 0x50a28be6 
  #define k6 0x5c4dd124 
  #define k7 0x6d703ef3 
  #define k8 0x7a6d76e9 

  unsigned int a, b, c, d, e, a1, b1, c1, d1, e1;

  a = Data[0];
  b = Data[1];
  c = Data[2];
  d = Data[3];
  e = Data[4];

  a += (b ^ c ^ d) + X[ 0]; a = ((a << 11) | (a >> (32 - 11))) + e; c = (c << 10) | (c >> 22);
  e += (a ^ b ^ c) + X[ 1]; e = ((e << 14) | (e >> (32 - 14))) + d; b = (b << 10) | (b >> 22);
  d += (e ^ a ^ b) + X[ 2]; d = ((d << 15) | (d >> (32 - 15))) + c; a = (a << 10) | (a >> 22);
  c += (d ^ e ^ a) + X[ 3]; c = ((c << 12) | (c >> (32 - 12))) + b; e = (e << 10) | (e >> 22);
  b += (c ^ d ^ e) + X[ 4]; b = ((b <<  5) | (b >> (32 -  5))) + a; d = (d << 10) | (d >> 22);
  a += (b ^ c ^ d) + X[ 5]; a = ((a <<  8) | (a >> (32 -  8))) + e; c = (c << 10) | (c >> 22);
  e += (a ^ b ^ c) + X[ 6]; e = ((e <<  7) | (e >> (32 -  7))) + d; b = (b << 10) | (b >> 22);
  d += (e ^ a ^ b) + X[ 7]; d = ((d <<  9) | (d >> (32 -  9))) + c; a = (a << 10) | (a >> 22);
  c += (d ^ e ^ a) + X[ 8]; c = ((c << 11) | (c >> (32 - 11))) + b; e = (e << 10) | (e >> 22);
  b += (c ^ d ^ e) + X[ 9]; b = ((b << 13) | (b >> (32 - 13))) + a; d = (d << 10) | (d >> 22);
  a += (b ^ c ^ d) + X[10]; a = ((a << 14) | (a >> (32 - 14))) + e; c = (c << 10) | (c >> 22);
  e += (a ^ b ^ c) + X[11]; e = ((e << 15) | (e >> (32 - 15))) + d; b = (b << 10) | (b >> 22);
  d += (e ^ a ^ b) + X[12]; d = ((d <<  6) | (d >> (32 -  6))) + c; a = (a << 10) | (a >> 22);
  c += (d ^ e ^ a) + X[13]; c = ((c <<  7) | (c >> (32 -  7))) + b; e = (e << 10) | (e >> 22);
  b += (c ^ d ^ e) + X[14]; b = ((b <<  9) | (b >> (32 -  9))) + a; d = (d << 10) | (d >> 22);
  a += (b ^ c ^ d) + X[15]; a = ((a <<  8) | (a >> (32 -  8))) + e; c = (c << 10) | (c >> 22);

  e += (c ^ (a & (b ^ c))) + X[ 7] + k1; e = ((e <<  7) | (e >> (32 -  7))) + d; b = (b << 10) | (b >> 22);
  d += (b ^ (e & (a ^ b))) + X[ 4] + k1; d = ((d <<  6) | (d >> (32 -  6))) + c; a = (a << 10) | (a >> 22);
  c += (a ^ (d & (e ^ a))) + X[13] + k1; c = ((c <<  8) | (c >> (32 -  8))) + b; e = (e << 10) | (e >> 22);
  b += (e ^ (c & (d ^ e))) + X[ 1] + k1; b = ((b << 13) | (b >> (32 - 13))) + a; d = (d << 10) | (d >> 22);
  a += (d ^ (b & (c ^ d))) + X[10] + k1; a = ((a << 11) | (a >> (32 - 11))) + e; c = (c << 10) | (c >> 22);
  e += (c ^ (a & (b ^ c))) + X[ 6] + k1; e = ((e <<  9) | (e >> (32 -  9))) + d; b = (b << 10) | (b >> 22);
  d += (b ^ (e & (a ^ b))) + X[15] + k1; d = ((d <<  7) | (d >> (32 -  7))) + c; a = (a << 10) | (a >> 22);
  c += (a ^ (d & (e ^ a))) + X[ 3] + k1; c = ((c << 15) | (c >> (32 - 15))) + b; e = (e << 10) | (e >> 22);
  b += (e ^ (c & (d ^ e))) + X[12] + k1; b = ((b <<  7) | (b >> (32 -  7))) + a; d = (d << 10) | (d >> 22);
  a += (d ^ (b & (c ^ d))) + X[ 0] + k1; a = ((a << 12) | (a >> (32 - 12))) + e; c = (c << 10) | (c >> 22);
  e += (c ^ (a & (b ^ c))) + X[ 9] + k1; e = ((e << 15) | (e >> (32 - 15))) + d; b = (b << 10) | (b >> 22);
  d += (b ^ (e & (a ^ b))) + X[ 5] + k1; d = ((d <<  9) | (d >> (32 -  9))) + c; a = (a << 10) | (a >> 22);
  c += (a ^ (d & (e ^ a))) + X[ 2] + k1; c = ((c << 11) | (c >> (32 - 11))) + b; e = (e << 10) | (e >> 22);
  b += (e ^ (c & (d ^ e))) + X[14] + k1; b = ((b <<  7) | (b >> (32 -  7))) + a; d = (d << 10) | (d >> 22);
  a += (d ^ (b & (c ^ d))) + X[11] + k1; a = ((a << 13) | (a >> (32 - 13))) + e; c = (c << 10) | (c >> 22);
  e += (c ^ (a & (b ^ c))) + X[ 8] + k1; e = ((e << 12) | (e >> (32 - 12))) + d; b = (b << 10) | (b >> 22);

  d += (b ^ (e | (~a))) + X[ 3] + k2; d = ((d << 11) | (d >> (32 - 11))) + c; a = (a << 10) | (a >> 22);
  c += (a ^ (d | (~e))) + X[10] + k2; c = ((c << 13) | (c >> (32 - 13))) + b; e = (e << 10) | (e >> 22);
  b += (e ^ (c | (~d))) + X[14] + k2; b = ((b <<  6) | (b >> (32 -  6))) + a; d = (d << 10) | (d >> 22);
  a += (d ^ (b | (~c))) + X[ 4] + k2; a = ((a <<  7) | (a >> (32 -  7))) + e; c = (c << 10) | (c >> 22);
  e += (c ^ (a | (~b))) + X[ 9] + k2; e = ((e << 14) | (e >> (32 - 14))) + d; b = (b << 10) | (b >> 22);
  d += (b ^ (e | (~a))) + X[15] + k2; d = ((d <<  9) | (d >> (32 -  9))) + c; a = (a << 10) | (a >> 22);
  c += (a ^ (d | (~e))) + X[ 8] + k2; c = ((c << 13) | (c >> (32 - 13))) + b; e = (e << 10) | (e >> 22);
  b += (e ^ (c | (~d))) + X[ 1] + k2; b = ((b << 15) | (b >> (32 - 15))) + a; d = (d << 10) | (d >> 22);
  a += (d ^ (b | (~c))) + X[ 2] + k2; a = ((a << 14) | (a >> (32 - 14))) + e; c = (c << 10) | (c >> 22);
  e += (c ^ (a | (~b))) + X[ 7] + k2; e = ((e <<  8) | (e >> (32 -  8))) + d; b = (b << 10) | (b >> 22);
  d += (b ^ (e | (~a))) + X[ 0] + k2; d = ((d << 13) | (d >> (32 - 13))) + c; a = (a << 10) | (a >> 22);
  c += (a ^ (d | (~e))) + X[ 6] + k2; c = ((c <<  6) | (c >> (32 -  6))) + b; e = (e << 10) | (e >> 22);
  b += (e ^ (c | (~d))) + X[13] + k2; b = ((b <<  5) | (b >> (32 -  5))) + a; d = (d << 10) | (d >> 22);
  a += (d ^ (b | (~c))) + X[11] + k2; a = ((a << 12) | (a >> (32 - 12))) + e; c = (c << 10) | (c >> 22);
  e += (c ^ (a | (~b))) + X[ 5] + k2; e = ((e <<  7) | (e >> (32 -  7))) + d; b = (b << 10) | (b >> 22);
  d += (b ^ (e | (~a))) + X[12] + k2; d = ((d <<  5) | (d >> (32 -  5))) + c; a = (a << 10) | (a >> 22);

  c += (e ^ (a & (d ^ e))) + X[ 1] + k3; c = ((c << 11) | (c >> (32 - 11))) + b; e = (e << 10) | (e >> 22);
  b += (d ^ (e & (c ^ d))) + X[ 9] + k3; b = ((b << 12) | (b >> (32 - 12))) + a; d = (d << 10) | (d >> 22);
  a += (c ^ (d & (b ^ c))) + X[11] + k3; a = ((a << 14) | (a >> (32 - 14))) + e; c = (c << 10) | (c >> 22);
  e += (b ^ (c & (a ^ b))) + X[10] + k3; e = ((e << 15) | (e >> (32 - 15))) + d; b = (b << 10) | (b >> 22);
  d += (a ^ (b & (e ^ a))) + X[ 0] + k3; d = ((d << 14) | (d >> (32 - 14))) + c; a = (a << 10) | (a >> 22);
  c += (e ^ (a & (d ^ e))) + X[ 8] + k3; c = ((c << 15) | (c >> (32 - 15))) + b; e = (e << 10) | (e >> 22);
  b += (d ^ (e & (c ^ d))) + X[12] + k3; b = ((b <<  9) | (b >> (32 -  9))) + a; d = (d << 10) | (d >> 22);
  a += (c ^ (d & (b ^ c))) + X[ 4] + k3; a = ((a <<  8) | (a >> (32 -  8))) + e; c = (c << 10) | (c >> 22);
  e += (b ^ (c & (a ^ b))) + X[13] + k3; e = ((e <<  9) | (e >> (32 -  9))) + d; b = (b << 10) | (b >> 22);
  d += (a ^ (b & (e ^ a))) + X[ 3] + k3; d = ((d << 14) | (d >> (32 - 14))) + c; a = (a << 10) | (a >> 22);
  c += (e ^ (a & (d ^ e))) + X[ 7] + k3; c = ((c <<  5) | (c >> (32 -  5))) + b; e = (e << 10) | (e >> 22);
  b += (d ^ (e & (c ^ d))) + X[15] + k3; b = ((b <<  6) | (b >> (32 -  6))) + a; d = (d << 10) | (d >> 22);
  a += (c ^ (d & (b ^ c))) + X[14] + k3; a = ((a <<  8) | (a >> (32 -  8))) + e; c = (c << 10) | (c >> 22);
  e += (b ^ (c & (a ^ b))) + X[ 5] + k3; e = ((e <<  6) | (e >> (32 -  6))) + d; b = (b << 10) | (b >> 22);
  d += (a ^ (b & (e ^ a))) + X[ 6] + k3; d = ((d <<  5) | (d >> (32 -  5))) + c; a = (a << 10) | (a >> 22);
  c += (e ^ (a & (d ^ e))) + X[ 2] + k3; c = ((c << 12) | (c >> (32 - 12))) + b; e = (e << 10) | (e >> 22);

  b += (c ^ (d | (~e))) + X[ 4] + k4; b = ((b <<  9) | (b >> (32 -  9))) + a; d = (d << 10) | (d >> 22);
  a += (b ^ (c | (~d))) + X[ 0] + k4; a = ((a << 15) | (a >> (32 - 15))) + e; c = (c << 10) | (c >> 22);
  e += (a ^ (b | (~c))) + X[ 5] + k4; e = ((e <<  5) | (e >> (32 -  5))) + d; b = (b << 10) | (b >> 22);
  d += (e ^ (a | (~b))) + X[ 9] + k4; d = ((d << 11) | (d >> (32 - 11))) + c; a = (a << 10) | (a >> 22);
  c += (d ^ (e | (~a))) + X[ 7] + k4; c = ((c <<  6) | (c >> (32 -  6))) + b; e = (e << 10) | (e >> 22);
  b += (c ^ (d | (~e))) + X[12] + k4; b = ((b <<  8) | (b >> (32 -  8))) + a; d = (d << 10) | (d >> 22);
  a += (b ^ (c | (~d))) + X[ 2] + k4; a = ((a << 13) | (a >> (32 - 13))) + e; c = (c << 10) | (c >> 22);
  e += (a ^ (b | (~c))) + X[10] + k4; e = ((e << 12) | (e >> (32 - 12))) + d; b = (b << 10) | (b >> 22);
  d += (e ^ (a | (~b))) + X[14] + k4; d = ((d <<  5) | (d >> (32 -  5))) + c; a = (a << 10) | (a >> 22);
  c += (d ^ (e | (~a))) + X[ 1] + k4; c = ((c << 12) | (c >> (32 - 12))) + b; e = (e << 10) | (e >> 22);
  b += (c ^ (d | (~e))) + X[ 3] + k4; b = ((b << 13) | (b >> (32 - 13))) + a; d = (d << 10) | (d >> 22);
  a += (b ^ (c | (~d))) + X[ 8] + k4; a = ((a << 14) | (a >> (32 - 14))) + e; c = (c << 10) | (c >> 22);
  e += (a ^ (b | (~c))) + X[11] + k4; e = ((e << 11) | (e >> (32 - 11))) + d; b = (b << 10) | (b >> 22);
  d += (e ^ (a | (~b))) + X[ 6] + k4; d = ((d <<  8) | (d >> (32 -  8))) + c; a = (a << 10) | (a >> 22);
  c += (d ^ (e | (~a))) + X[15] + k4; c = ((c <<  5) | (c >> (32 -  5))) + b; e = (e << 10) | (e >> 22);
  b += (c ^ (d | (~e))) + X[13] + k4; b = ((b <<  6) | (b >> (32 -  6))) + a; d = (d << 10) | (d >> 22);

  a1 = a; a = Data[0];
  b1 = b; b = Data[1];
  c1 = c; c = Data[2];
  d1 = d; d = Data[3];
  e1 = e; e = Data[4];

  a += (b ^ (c | (~d))) + X[ 5] + k5; a = ((a <<  8) | (a >> (32 -  8))) + e; c = (c << 10) | (c >> 22);
  e += (a ^ (b | (~c))) + X[14] + k5; e = ((e <<  9) | (e >> (32 -  9))) + d; b = (b << 10) | (b >> 22);
  d += (e ^ (a | (~b))) + X[ 7] + k5; d = ((d <<  9) | (d >> (32 -  9))) + c; a = (a << 10) | (a >> 22);
  c += (d ^ (e | (~a))) + X[ 0] + k5; c = ((c << 11) | (c >> (32 - 11))) + b; e = (e << 10) | (e >> 22);
  b += (c ^ (d | (~e))) + X[ 9] + k5; b = ((b << 13) | (b >> (32 - 13))) + a; d = (d << 10) | (d >> 22);
  a += (b ^ (c | (~d))) + X[ 2] + k5; a = ((a << 15) | (a >> (32 - 15))) + e; c = (c << 10) | (c >> 22);
  e += (a ^ (b | (~c))) + X[11] + k5; e = ((e << 15) | (e >> (32 - 15))) + d; b = (b << 10) | (b >> 22);
  d += (e ^ (a | (~b))) + X[ 4] + k5; d = ((d <<  5) | (d >> (32 -  5))) + c; a = (a << 10) | (a >> 22);
  c += (d ^ (e | (~a))) + X[13] + k5; c = ((c <<  7) | (c >> (32 -  7))) + b; e = (e << 10) | (e >> 22);
  b += (c ^ (d | (~e))) + X[ 6] + k5; b = ((b <<  7) | (b >> (32 -  7))) + a; d = (d << 10) | (d >> 22);
  a += (b ^ (c | (~d))) + X[15] + k5; a = ((a <<  8) | (a >> (32 -  8))) + e; c = (c << 10) | (c >> 22);
  e += (a ^ (b | (~c))) + X[ 8] + k5; e = ((e << 11) | (e >> (32 - 11))) + d; b = (b << 10) | (b >> 22);
  d += (e ^ (a | (~b))) + X[ 1] + k5; d = ((d << 14) | (d >> (32 - 14))) + c; a = (a << 10) | (a >> 22);
  c += (d ^ (e | (~a))) + X[10] + k5; c = ((c << 14) | (c >> (32 - 14))) + b; e = (e << 10) | (e >> 22);
  b += (c ^ (d | (~e))) + X[ 3] + k5; b = ((b << 12) | (b >> (32 - 12))) + a; d = (d << 10) | (d >> 22);
  a += (b ^ (c | (~d))) + X[12] + k5; a = ((a <<  6) | (a >> (32 -  6))) + e; c = (c << 10) | (c >> 22);

  e += (b ^ (c & (a ^ b))) + X[ 6] + k6; e = ((e <<  9) | (e >> (32 -  9))) + d; b = (b << 10) | (b >> 22);
  d += (a ^ (b & (e ^ a))) + X[11] + k6; d = ((d << 13) | (d >> (32 - 13))) + c; a = (a << 10) | (a >> 22);
  c += (e ^ (a & (d ^ e))) + X[ 3] + k6; c = ((c << 15) | (c >> (32 - 15))) + b; e = (e << 10) | (e >> 22);
  b += (d ^ (e & (c ^ d))) + X[ 7] + k6; b = ((b <<  7) | (b >> (32 -  7))) + a; d = (d << 10) | (d >> 22);
  a += (c ^ (d & (b ^ c))) + X[ 0] + k6; a = ((a << 12) | (a >> (32 - 12))) + e; c = (c << 10) | (c >> 22);
  e += (b ^ (c & (a ^ b))) + X[13] + k6; e = ((e <<  8) | (e >> (32 -  8))) + d; b = (b << 10) | (b >> 22);
  d += (a ^ (b & (e ^ a))) + X[ 5] + k6; d = ((d <<  9) | (d >> (32 -  9))) + c; a = (a << 10) | (a >> 22);
  c += (e ^ (a & (d ^ e))) + X[10] + k6; c = ((c << 11) | (c >> (32 - 11))) + b; e = (e << 10) | (e >> 22);
  b += (d ^ (e & (c ^ d))) + X[14] + k6; b = ((b <<  7) | (b >> (32 -  7))) + a; d = (d << 10) | (d >> 22);
  a += (c ^ (d & (b ^ c))) + X[15] + k6; a = ((a <<  7) | (a >> (32 -  7))) + e; c = (c << 10) | (c >> 22);
  e += (b ^ (c & (a ^ b))) + X[ 8] + k6; e = ((e << 12) | (e >> (32 - 12))) + d; b = (b << 10) | (b >> 22);
  d += (a ^ (b & (e ^ a))) + X[12] + k6; d = ((d <<  7) | (d >> (32 -  7))) + c; a = (a << 10) | (a >> 22);
  c += (e ^ (a & (d ^ e))) + X[ 4] + k6; c = ((c <<  6) | (c >> (32 -  6))) + b; e = (e << 10) | (e >> 22);
  b += (d ^ (e & (c ^ d))) + X[ 9] + k6; b = ((b << 15) | (b >> (32 - 15))) + a; d = (d << 10) | (d >> 22);
  a += (c ^ (d & (b ^ c))) + X[ 1] + k6; a = ((a << 13) | (a >> (32 - 13))) + e; c = (c << 10) | (c >> 22);
  e += (b ^ (c & (a ^ b))) + X[ 2] + k6; e = ((e << 11) | (e >> (32 - 11))) + d; b = (b << 10) | (b >> 22);

  d += (b ^ (e | (~a))) + X[15] + k7; d = ((d <<  9) | (d >> (32 -  9))) + c; a = (a << 10) | (a >> 22);
  c += (a ^ (d | (~e))) + X[ 5] + k7; c = ((c <<  7) | (c >> (32 -  7))) + b; e = (e << 10) | (e >> 22);
  b += (e ^ (c | (~d))) + X[ 1] + k7; b = ((b << 15) | (b >> (32 - 15))) + a; d = (d << 10) | (d >> 22);
  a += (d ^ (b | (~c))) + X[ 3] + k7; a = ((a << 11) | (a >> (32 - 11))) + e; c = (c << 10) | (c >> 22);
  e += (c ^ (a | (~b))) + X[ 7] + k7; e = ((e <<  8) | (e >> (32 -  8))) + d; b = (b << 10) | (b >> 22);
  d += (b ^ (e | (~a))) + X[14] + k7; d = ((d <<  6) | (d >> (32 -  6))) + c; a = (a << 10) | (a >> 22);
  c += (a ^ (d | (~e))) + X[ 6] + k7; c = ((c <<  6) | (c >> (32 -  6))) + b; e = (e << 10) | (e >> 22);
  b += (e ^ (c | (~d))) + X[ 9] + k7; b = ((b << 14) | (b >> (32 - 14))) + a; d = (d << 10) | (d >> 22);
  a += (d ^ (b | (~c))) + X[11] + k7; a = ((a << 12) | (a >> (32 - 12))) + e; c = (c << 10) | (c >> 22);
  e += (c ^ (a | (~b))) + X[ 8] + k7; e = ((e << 13) | (e >> (32 - 13))) + d; b = (b << 10) | (b >> 22);
  d += (b ^ (e | (~a))) + X[12] + k7; d = ((d <<  5) | (d >> (32 -  5))) + c; a = (a << 10) | (a >> 22);
  c += (a ^ (d | (~e))) + X[ 2] + k7; c = ((c << 14) | (c >> (32 - 14))) + b; e = (e << 10) | (e >> 22);
  b += (e ^ (c | (~d))) + X[10] + k7; b = ((b << 13) | (b >> (32 - 13))) + a; d = (d << 10) | (d >> 22);
  a += (d ^ (b | (~c))) + X[ 0] + k7; a = ((a << 13) | (a >> (32 - 13))) + e; c = (c << 10) | (c >> 22);
  e += (c ^ (a | (~b))) + X[ 4] + k7; e = ((e <<  7) | (e >> (32 -  7))) + d; b = (b << 10) | (b >> 22);
  d += (b ^ (e | (~a))) + X[13] + k7; d = ((d <<  5) | (d >> (32 -  5))) + c; a = (a << 10) | (a >> 22);

  c += (a ^ (d & (e ^ a))) + X[ 8] + k8; c = ((c << 15) | (c >> (32 - 15))) + b; e = (e << 10) | (e >> 22);
  b += (e ^ (c & (d ^ e))) + X[ 6] + k8; b = ((b <<  5) | (b >> (32 -  5))) + a; d = (d << 10) | (d >> 22);
  a += (d ^ (b & (c ^ d))) + X[ 4] + k8; a = ((a <<  8) | (a >> (32 -  8))) + e; c = (c << 10) | (c >> 22);
  e += (c ^ (a & (b ^ c))) + X[ 1] + k8; e = ((e << 11) | (e >> (32 - 11))) + d; b = (b << 10) | (b >> 22);
  d += (b ^ (e & (a ^ b))) + X[ 3] + k8; d = ((d << 14) | (d >> (32 - 14))) + c; a = (a << 10) | (a >> 22);
  c += (a ^ (d & (e ^ a))) + X[11] + k8; c = ((c << 14) | (c >> (32 - 14))) + b; e = (e << 10) | (e >> 22);
  b += (e ^ (c & (d ^ e))) + X[15] + k8; b = ((b <<  6) | (b >> (32 -  6))) + a; d = (d << 10) | (d >> 22);
  a += (d ^ (b & (c ^ d))) + X[ 0] + k8; a = ((a << 14) | (a >> (32 - 14))) + e; c = (c << 10) | (c >> 22);
  e += (c ^ (a & (b ^ c))) + X[ 5] + k8; e = ((e <<  6) | (e >> (32 -  6))) + d; b = (b << 10) | (b >> 22);
  d += (b ^ (e & (a ^ b))) + X[12] + k8; d = ((d <<  9) | (d >> (32 -  9))) + c; a = (a << 10) | (a >> 22);
  c += (a ^ (d & (e ^ a))) + X[ 2] + k8; c = ((c << 12) | (c >> (32 - 12))) + b; e = (e << 10) | (e >> 22);
  b += (e ^ (c & (d ^ e))) + X[13] + k8; b = ((b <<  9) | (b >> (32 -  9))) + a; d = (d << 10) | (d >> 22);
  a += (d ^ (b & (c ^ d))) + X[ 9] + k8; a = ((a << 12) | (a >> (32 - 12))) + e; c = (c << 10) | (c >> 22);
  e += (c ^ (a & (b ^ c))) + X[ 7] + k8; e = ((e <<  5) | (e >> (32 -  5))) + d; b = (b << 10) | (b >> 22);
  d += (b ^ (e & (a ^ b))) + X[10] + k8; d = ((d << 15) | (d >> (32 - 15))) + c; a = (a << 10) | (a >> 22);
  c += (a ^ (d & (e ^ a))) + X[14] + k8; c = ((c <<  8) | (c >> (32 -  8))) + b; e = (e << 10) | (e >> 22);

  b += (c ^ d ^ e) + X[12]; b = ((b <<  8) | (b >> (32 -  8))) + a; d = (d << 10) | (d >> 22);
  a += (b ^ c ^ d) + X[15]; a = ((a <<  5) | (a >> (32 -  5))) + e; c = (c << 10) | (c >> 22);
  e += (a ^ b ^ c) + X[10]; e = ((e << 12) | (e >> (32 - 12))) + d; b = (b << 10) | (b >> 22);
  d += (e ^ a ^ b) + X[ 4]; d = ((d <<  9) | (d >> (32 -  9))) + c; a = (a << 10) | (a >> 22);
  c += (d ^ e ^ a) + X[ 1]; c = ((c << 12) | (c >> (32 - 12))) + b; e = (e << 10) | (e >> 22);
  b += (c ^ d ^ e) + X[ 5]; b = ((b <<  5) | (b >> (32 -  5))) + a; d = (d << 10) | (d >> 22);
  a += (b ^ c ^ d) + X[ 8]; a = ((a << 14) | (a >> (32 - 14))) + e; c = (c << 10) | (c >> 22);
  e += (a ^ b ^ c) + X[ 7]; e = ((e <<  6) | (e >> (32 -  6))) + d; b = (b << 10) | (b >> 22);
  d += (e ^ a ^ b) + X[ 6]; d = ((d <<  8) | (d >> (32 -  8))) + c; a = (a << 10) | (a >> 22);
  c += (d ^ e ^ a) + X[ 2]; c = ((c << 13) | (c >> (32 - 13))) + b; e = (e << 10) | (e >> 22);
  b += (c ^ d ^ e) + X[13]; b = ((b <<  6) | (b >> (32 -  6))) + a; d = (d << 10) | (d >> 22);
  a += (b ^ c ^ d) + X[14]; a = ((a <<  5) | (a >> (32 -  5))) + e; c = (c << 10) | (c >> 22);
  e += (a ^ b ^ c) + X[ 0]; e = ((e << 15) | (e >> (32 - 15))) + d; b = (b << 10) | (b >> 22);
  d += (e ^ a ^ b) + X[ 3]; d = ((d << 13) | (d >> (32 - 13))) + c; a = (a << 10) | (a >> 22);
  c += (d ^ e ^ a) + X[ 9]; c = ((c << 11) | (c >> (32 - 11))) + b; e = (e << 10) | (e >> 22);
  b += (c ^ d ^ e) + X[11]; b = ((b << 11) | (b >> (32 - 11))) + a; d = (d << 10) | (d >> 22);

  d       = Data[1] + c1 + d;
  Data[1] = Data[2] + d1 + e;
  Data[2] = Data[3] + e1 + a;
  Data[3] = Data[4] + a1 + b;
  Data[4] = Data[0] + b1 + c;
  Data[0] = d;
}

void UpdateHash(THashContext *Context, void *Buf, int Len)
// update the hash value; can be called multiple times
{
  Context->Len += ((unsigned __int64)Len) << 3;
  while (Len > 0)
  {
    Context->Buf[Context->Index] = *((unsigned char*)Buf);
    Buf = (void*) (((unsigned __int64) Buf) + 1);
    Context->Index++;
    Len--;
    if (Context->Index == 64)
    {
      Context->Index = 0;
      CalculateHash((void*)Context->State, (void*)Context->Buf);
      while (Len >= 64)
      {
        memcpy(Context->Buf, Buf, 64);
        CalculateHash((void*)Context->State, (void*)Context->Buf);
        Buf = (void*) (((unsigned __int64) Buf) + 64);
        Len -= 64;
      } 
    }
  }
}

// ********************************************************************

void CloseHash(THashContext *Context, unsigned int *Digest)
// finish hash calculation and return the final hash result
{
  int i;

  // finish hash calculation
  Context->Buf[Context->Index] = 0x80;
  for (i = Context->Index + 1; i < 64; i++)
    Context->Buf[i] = 0;
  if (Context->Index >= 56)
  {
    CalculateHash((void*)Context->State, (void*)Context->Buf);
    memset(Context->Buf, 0, 56);
  }
  *((unsigned __int64*)&Context->Buf[56]) = Context->Len;
  CalculateHash((void*)Context->State, (void*)Context->Buf);

  // copy final result to the "Digest" output parameter
  memcpy(Digest, Context->State, 20);
}

// ********************************************************************

void Hash(void *Buf, int Len, unsigned int *Digest)
{
  THashContext hash;

  InitHash(&hash);
  UpdateHash(&hash, Buf, Len);
  CloseHash(&hash, Digest);
}

// ********************************************************************
